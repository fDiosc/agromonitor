generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== MULTI-TENANCY ====================

model Workspace {
  id       String  @id @default(cuid())
  name     String // Nome da empresa
  slug     String  @unique // URL amigável (ex: "merx", "trading-abc")
  logo     String? // URL do logo
  isActive Boolean @default(true)

  // Configurações do workspace (JSON) - Legacy, migrar para WorkspaceSettings
  settings String?

  // Limites e quotas
  maxFields Int @default(100)
  maxUsers  Int @default(10)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  users            User[]
  fields           Field[]
  producers        Producer[]
  logisticsUnits   LogisticsUnit[]
  featureSettings  WorkspaceSettings?

  @@index([slug])
}

// ==================== FEATURE FLAGS ====================

model WorkspaceSettings {
  id          String    @id @default(cuid())
  workspaceId String    @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // ===== MÓDULOS DE DADOS =====
  // Controla se o sistema busca e processa esses dados
  enablePrecipitation    Boolean @default(true)   // Dados de precipitação
  enableWaterBalance     Boolean @default(false)  // Balanço hídrico
  enableRadarNdvi        Boolean @default(false)  // Sentinel-1 para gaps
  enableThermalSum       Boolean @default(false)  // Soma térmica (GDD)
  enableSoilData         Boolean @default(false)  // Dados de solo
  enableClimateEnvelope  Boolean @default(false)  // Bandas históricas clima

  // ===== VISUALIZAÇÕES =====
  // Controla quais gráficos aparecem na UI
  showPrecipitationChart Boolean @default(true)
  showWaterBalanceChart  Boolean @default(false)
  showRadarOverlay       Boolean @default(false)
  showGddChart           Boolean @default(false)
  showSoilInfo           Boolean @default(true)
  showClimateEnvelope    Boolean @default(false)
  showSatelliteSchedule  Boolean @default(true)   // Próximas passagens

  // ===== CÁLCULOS AVANÇADOS =====
  // Controla se algoritmos usam esses dados nos cálculos
  useRadarForGaps        Boolean @default(false)  // Usar radar para preencher gaps NDVI
  useLocalCalibration    Boolean @default(false)  // Treinar modelo local RVI->NDVI por talhão
  enableSarNdviFusion    Boolean @default(false)  // [BETA] Fusão adaptativa SAR-NDVI com GPR/KNN
  useGddForEos           Boolean @default(false)  // Usar GDD na projeção de EOS
  useWaterBalanceAdjust  Boolean @default(false)  // Ajustar EOS por balanço hídrico
  usePrecipitationAdjust Boolean @default(true)   // Ajustar colheita por precipitação

  // ===== AUTO-REPROCESSAMENTO =====
  enableAutoReprocess      Boolean @default(false)           // Habilitar reprocessamento automático
  autoReprocessFrequency   String  @default("ON_NEW_DATA")   // ON_NEW_DATA | DAILY | WEEKLY
  autoReprocessNotify      Boolean @default(true)            // Notificar por email
  autoReprocessWebhookUrl  String?                           // URL do webhook (opcional)

  // ===== CONFIGURAÇÕES GERAIS =====
  distanceCalculationMethod String @default("straight_line") // straight_line | road_distance
  googleMapsApiKey          String?                          // Chave API Google Maps

  // ===== CREDENCIAIS EXTERNAS =====
  // Copernicus Data Space (para Sentinel-1 radar)
  copernicusClientId        String?                          // OAuth2 Client ID
  copernicusClientSecret    String?                          // OAuth2 Client Secret (criptografado)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String

  // Status e controle
  isActive           Boolean  @default(true)
  role               UserRole @default(VIEWER)
  mustChangePassword Boolean  @default(true) // Força troca no primeiro login

  // Disclaimer de termos (Alpha/Beta)
  hasAcceptedDisclaimer  Boolean   @default(false)
  disclaimerAcceptedAt   DateTime?
  disclaimerVersionAccepted String?  // Versão aceita (ex: "0.0.7")

  // Workspace
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  // Sessões
  lastLoginAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit trail
  createdFields Field[] @relation("CreatedBy")

  @@index([workspaceId])
  @@index([email])
}

enum UserRole {
  SUPER_ADMIN // Pode gerenciar workspaces
  ADMIN       // Pode gerenciar usuários do workspace
  OPERATOR    // Pode criar/editar talhões
  VIEWER      // Apenas visualização
}

// ==================== CAIXAS LOGÍSTICAS ====================

model LogisticsUnit {
  id   String @id @default(cuid())
  name String

  // Localização
  latitude  Float?
  longitude Float?
  address   String?
  city      String?
  state     String?

  // Área de atuação (raio em km, null = sem limite)
  coverageRadiusKm Float?

  // Status
  isActive Boolean @default(true)

  // Capacidade (para uso futuro)
  dailyCapacityTons   Float?
  storageCapacityTons Float?

  // Multi-tenancy
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos inversos
  producers Producer[] // Produtores com esta caixa como default
  fields    Field[]    // Talhões atribuídos diretamente
  fieldDistances FieldLogisticsDistance[] // Distâncias calculadas

  @@index([workspaceId])
  @@index([workspaceId, isActive])
}

// ==================== DISTÂNCIAS TALHÃO-CAIXA ====================

model FieldLogisticsDistance {
  id String @id @default(cuid())

  // Relacionamentos
  fieldId          String
  field            Field         @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  logisticsUnitId  String
  logisticsUnit    LogisticsUnit @relation(fields: [logisticsUnitId], references: [id], onDelete: Cascade)

  // Distância calculada
  distanceKm       Float         // Distância em km
  isWithinCoverage Boolean       // Se está dentro do raio de cobertura
  
  // Método usado no cálculo
  calculationMethod String       // 'straight_line' | 'road_distance'

  // Timestamps
  calculatedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([fieldId, logisticsUnitId])
  @@index([fieldId])
  @@index([logisticsUnitId])
  @@index([isWithinCoverage])
}

// ==================== PRODUTORES ====================

model Producer {
  id   String  @id @default(cuid())
  name String
  cpf  String? // Opcional

  // Multi-tenancy
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  // Caixa logística padrão (opcional)
  // Talhões sem atribuição específica herdam esta caixa
  defaultLogisticsUnitId String?
  defaultLogisticsUnit   LogisticsUnit? @relation(fields: [defaultLogisticsUnitId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  fields Field[]

  @@index([workspaceId])
  @@index([workspaceId, name])
  @@index([defaultLogisticsUnitId])
}

// ==================== TIPOS DE CULTURA ====================

enum CropType {
  SOJA
  MILHO
}

// ==================== TALHÕES ====================

model Field {
  id              String   @id @default(cuid())
  name            String
  cropType        CropType @default(SOJA) // Tipo de cultura
  seasonStartDate DateTime
  status          String   @default("PENDING") // PENDING, PROCESSING, SUCCESS, PARTIAL, ERROR
  errorMessage    String?

  // Versionamento de dados - incrementa a cada processamento
  dataVersion Int @default(1)

  // Data de plantio informada pelo produtor (opcional)
  // Se informada, é usada como base 100% confiável para cálculos
  plantingDateInput DateTime?

  // Localização
  city      String?
  state     String?
  latitude  Float?
  longitude Float?
  areaHa    Float?

  // Geometria (JSON armazenado como string)
  geometryJson String // GeoJSON stringified

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  // Produtor vinculado (opcional)
  producerId String?
  producer   Producer? @relation(fields: [producerId], references: [id])

  // Multi-tenancy (opcional para migração de dados existentes)
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  // Caixa logística atribuída (opcional)
  // Se null, herda do produtor ou é calculada automaticamente
  logisticsUnitId String?
  logisticsUnit   LogisticsUnit? @relation(fields: [logisticsUnitId], references: [id])

  // Audit
  createdById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])

  // Relações
  agroData AgroData?
  analyses Analysis[]
  ndviData NdviDataPoint[]
  logisticsDistances FieldLogisticsDistance[]
  dataStatus FieldDataStatus?
  rviCalibrations RviNdviCalibration[]
  rviNdviPairs RviNdviPair[]

  @@index([workspaceId])
  @@index([workspaceId, status])
  @@index([producerId])
  @@index([logisticsUnitId])
}

// ==================== STATUS DE DADOS DO TALHÃO ====================

model FieldDataStatus {
  id      String @id @default(cuid())
  fieldId String @unique
  field   Field  @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  // Sentinel-2 (NDVI Óptico)
  lastS2Acquisition DateTime?  // Última data com dados S2
  nextS2Expected    DateTime?  // Próxima passagem esperada
  s2DataAvailable   Boolean    @default(false)

  // Sentinel-1 (Radar)
  lastS1Acquisition DateTime?
  nextS1Expected    DateTime?
  s1DataAvailable   Boolean    @default(false)

  // Status de dados adicionais
  lastPrecipData    DateTime?  // Última data com precipitação
  lastTempData      DateTime?  // Última data com temperatura

  // Status de reprocessamento
  needsReprocessing    Boolean   @default(false)
  reprocessReason      String?   // Motivo do reprocessamento
  lastProcessedAt      DateTime?
  autoReprocessEnabled Boolean   @default(false)
  lastReprocessTrigger String?   // MANUAL | AUTO_CRON | WEBHOOK | NEW_DATA

  // Qualidade dos dados
  dataCompleteness     Float?    // % de dias com dados no período
  gapsFilledByRadar    Int       @default(0)  // Quantos gaps preenchidos por radar

  // Status das Fontes de Dados (para graceful degradation badges)
  precipitationStatus  String?   // SUCCESS | PARTIAL | UNAVAILABLE
  precipitationMessage String?
  waterBalanceStatus   String?
  waterBalanceMessage  String?
  radarStatus          String?
  radarMessage         String?
  temperatureStatus    String?
  temperatureMessage   String?
  soilStatus           String?
  soilMessage          String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([needsReprocessing, autoReprocessEnabled])
}

// ==================== DADOS AGRONÔMICOS (BASE) ====================
// Dados que são sempre os mesmos, independente do template

model AgroData {
  id String @id @default(cuid())

  // Métricas base
  areaHa            Float?
  volumeEstimatedKg Float?

  // Fenologia detectada
  plantingDate          DateTime?
  sosDate               DateTime?
  eosDate               DateTime?
  peakDate              DateTime?
  cycleDays             Int?
  phenologyMethod       String? // ALGORITHM | PROJECTION
  confidenceScore       Int?
  confidence            String? // HIGH | MEDIUM | LOW
  historicalCorrelation Float?

  // Detecções avançadas
  detectedReplanting Boolean   @default(false)
  replantingDate     DateTime?
  yieldEstimateKgHa  Float? // Produtividade estimada kg/ha
  phenologyHealth    String? // EXCELLENT | GOOD | FAIR | POOR
  peakNdvi           Float? // NDVI máximo detectado

  // Dados brutos da API Merx (JSON stringified)
  rawNdviData       String?
  rawPrecipData     String?
  rawSoilData       String?
  rawHistoricalData String?
  rawAreaData       String?
  rawZarcData       String?

  // ZARC - Janela de Plantio
  zarcWindowStart   DateTime?  // Início da janela de plantio ZARC
  zarcWindowEnd     DateTime?  // Fim da janela de plantio ZARC
  zarcOptimalStart  DateTime?  // Início da janela ideal (ZARC = 20)
  zarcOptimalEnd    DateTime?  // Fim da janela ideal (ZARC = 20)
  zarcPlantingRisk  Int?       // Risco no momento do plantio (0/20/30/40)
  zarcPlantingStatus String?   // IDEAL | MODERATE | HIGH_RISK | OUT_OF_WINDOW

  // Diagnósticos do processamento
  diagnostics String? // JSON array of diagnostics

  // Relação 1:1 com Field
  fieldId String @unique
  field   Field  @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== ANÁLISES POR TEMPLATE ====================

model Analysis {
  id String @id @default(cuid())

  // Template usado
  templateId      String // CREDIT | LOGISTICS | RISK_MATRIX
  templateVersion String @default("1.0.0")

  // Status da análise
  status      String // NORMAL | ALERTA | CRITICO (ou equivalente do template)
  statusLabel String? // Label customizado do template
  statusColor String? // Cor para UI (green, yellow, red)

  // Resultado da IA
  aiSummary         String?
  aiMetrics         String? // JSON - métricas específicas do template
  aiRisks           String? // JSON array
  aiRecommendations String? // JSON array
  aiFullResponse    String? // JSON completo da resposta

  // Metadados
  promptVersion    String?
  modelUsed        String?
  processingTimeMs Int?
  fallbackUsed     Boolean @default(false)

  // Controle de versão e reprocessamento
  dataVersion      Int       @default(1)    // Versão dos dados quando gerada
  isStale          Boolean   @default(false) // Se está desatualizada
  staleReason      String?                   // Motivo da desatualização
  reprocessStatus  String?                   // PENDING | PROCESSING | COMPLETED | FAILED
  reprocessError   String?                   // Erro se falhou
  reprocessedAt    DateTime?                 // Última tentativa de reprocessamento

  // Relação com Field
  fieldId String
  field   Field  @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([fieldId, templateId])
  @@index([fieldId, templateId])
  @@index([isStale, reprocessStatus])
}

// ==================== TEMPLATES DE ANÁLISE ====================

model AnalysisTemplate {
  id          String  @id // CREDIT, LOGISTICS, RISK_MATRIX
  name        String // "Análise de Crédito"
  description String?
  icon        String? // Nome do ícone (lucide)
  color       String? // Cor tema

  // Configuração
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  // Schema de métricas (JSON)
  metricsSchema String? // Define quais métricas esse template gera

  // Versão atual
  currentVersion String @default("1.0.0")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== SÉRIES TEMPORAIS ====================

model NdviDataPoint {
  id           String   @id @default(cuid())
  date         DateTime
  ndviRaw      Float?
  ndviSmooth   Float?
  ndviInterp   Float?
  cloudCover   Float?
  isHistorical Boolean  @default(false)
  seasonYear   Int?

  fieldId String
  field   Field  @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([fieldId, date, seasonYear])
  @@index([fieldId, date])
}

// ==================== CALIBRAÇÃO RVI-NDVI ====================
// Baseado em: Pelta et al. (2022) "SNAF: Sentinel-1 to NDVI for Agricultural Fields"

model RviNdviCalibration {
  id       String @id @default(cuid())
  fieldId  String
  field    Field  @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  
  // Coeficientes do modelo: NDVI = a * RVI + b
  coefficientA  Float    // Slope
  coefficientB  Float    // Intercept
  rSquared      Float    // Qualidade do ajuste (R²)
  rmse          Float    // RMSE do modelo
  sampleCount   Int      // Número de pares usados
  
  // Período do treinamento
  trainPeriodStart DateTime
  trainPeriodEnd   DateTime
  
  // Metadados
  cropType      String    // SOJA | MILHO
  isActive      Boolean   @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([fieldId, cropType])
  @@index([fieldId])
}

model RviNdviPair {
  id      String   @id @default(cuid())
  fieldId String
  field   Field    @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  
  date       DateTime
  ndviValue  Float     // NDVI óptico observado
  rviValue   Float     // RVI calculado do radar
  
  // Qualidade
  cloudCover Float?    // % nuvens no óptico
  quality    Float     // 0-1
  
  createdAt DateTime @default(now())
  
  @@unique([fieldId, date])
  @@index([fieldId, date])
}
